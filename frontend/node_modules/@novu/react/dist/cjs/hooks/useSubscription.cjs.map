{"version":3,"sources":["../../../src/hooks/useSubscription.ts"],"sourcesContent":["import { NovuError, TopicSubscription } from '@novu/js';\nimport { buildSubscriptionIdentifier } from '@novu/js/internal';\nimport { useCallback, useEffect, useRef, useState } from 'react';\nimport { useNovu } from './NovuProvider';\n\nexport type UseSubscriptionProps = {\n  topicKey: string;\n  identifier?: string;\n  onSuccess?: (data: TopicSubscription | null) => void;\n  onError?: (error: NovuError) => void;\n};\n\nexport type UseSubscriptionResult = {\n  subscription?: TopicSubscription | null;\n  error?: NovuError;\n  isLoading: boolean;\n  isFetching: boolean;\n  refetch: () => Promise<void>;\n};\n\n/**\n * Get a subscription for a topic.\n */\nexport const useSubscription = (props: UseSubscriptionProps): UseSubscriptionResult => {\n  const novu = useNovu();\n  const propsRef = useRef<UseSubscriptionProps>(props);\n  propsRef.current = {\n    ...props,\n    identifier:\n      props.identifier ?? buildSubscriptionIdentifier({ topicKey: props.topicKey, subscriberId: novu.subscriberId }),\n  };\n  const [subscription, setSubscription] = useState<TopicSubscription | null>();\n  const subscriptionRef = useRef<TopicSubscription | null>(null);\n  subscriptionRef.current = subscription ?? null;\n  const [error, setError] = useState<NovuError>();\n  const [isLoading, setIsLoading] = useState(true);\n  const [isFetching, setIsFetching] = useState(false);\n\n  const fetchSubscription = useCallback(\n    async (options?: { refetch: boolean }) => {\n      const { topicKey, identifier, onSuccess, onError } = propsRef.current;\n      if (options?.refetch) {\n        setError(undefined);\n        setIsLoading(true);\n      }\n\n      setIsFetching(true);\n\n      const response = await novu.subscriptions.get(\n        {\n          topicKey,\n          identifier,\n        },\n        { refetch: options?.refetch }\n      );\n\n      if (response.error) {\n        setError(response.error);\n        onError?.(response.error);\n      } else if (response.data !== undefined) {\n        onSuccess?.(response.data);\n        setSubscription(response.data);\n      }\n      setIsLoading(false);\n      setIsFetching(false);\n    },\n    [novu]\n  );\n\n  useEffect(() => {\n    const listener = ({ data: subscription }: { data?: TopicSubscription }) => {\n      const { topicKey, identifier } = propsRef.current;\n      if (!subscription || subscription.topicKey !== topicKey || subscription.identifier !== identifier) {\n        return;\n      }\n\n      setSubscription(subscription);\n      setIsFetching(false);\n    };\n\n    const cleanupGetPending = novu.on('subscription.get.pending', ({ args }) => {\n      const { topicKey, identifier } = propsRef.current;\n      if (!args || args.topicKey !== topicKey || args.identifier !== identifier) {\n        return;\n      }\n      setIsFetching(true);\n    });\n\n    const cleanupGetResolved = novu.on('subscription.get.resolved', ({ args, data, error }) => {\n      const { topicKey, identifier, onSuccess, onError } = propsRef.current;\n      if (!args || args.topicKey !== topicKey || args.identifier !== identifier) {\n        return;\n      }\n      if (error) {\n        setError(error as NovuError);\n        onError?.(error as NovuError);\n      } else {\n        setSubscription(data ?? null);\n        onSuccess?.(data ?? null);\n      }\n      setIsFetching(false);\n    });\n\n    const cleanupCreatePending = novu.on('subscription.create.pending', ({ args }) => {\n      const { topicKey, identifier } = propsRef.current;\n      if (!args || args.topicKey !== topicKey || args.identifier !== identifier) {\n        return;\n      }\n      setIsFetching(true);\n    });\n\n    const cleanupCreateResolved = novu.on('subscription.create.resolved', listener);\n\n    const cleanupUpdateResolved = novu.on('subscription.update.resolved', listener);\n\n    const cleanupDeletePending = novu.on('subscription.delete.pending', ({ args }) => {\n      const subscriptionId = subscriptionRef.current?.id;\n      const subscriptionIdentifier = subscriptionRef.current?.identifier;\n      if (!subscriptionId || !subscriptionIdentifier) {\n        return;\n      }\n\n      if (\n        !args ||\n        ('subscriptionId' in args &&\n          args.subscriptionId !== subscriptionId &&\n          args.subscriptionId !== subscriptionIdentifier) ||\n        ('subscription' in args &&\n          args.subscription.id !== subscriptionId &&\n          args.subscription.identifier !== subscriptionIdentifier)\n      ) {\n        return;\n      }\n      setIsFetching(true);\n    });\n\n    const cleanupDeleteResolved = novu.on('subscription.delete.resolved', ({ args }) => {\n      const subscriptionId = subscriptionRef.current?.id;\n      const subscriptionIdentifier = subscriptionRef.current?.identifier;\n      if (!subscriptionId || !subscriptionIdentifier) {\n        return;\n      }\n\n      if (\n        ('subscriptionId' in args && args.subscriptionId === subscriptionId) ||\n        ('subscriptionId' in args && args.subscriptionId === subscriptionIdentifier) ||\n        ('subscription' in args && args.subscription.id === subscriptionId) ||\n        ('subscription' in args && args.subscription.identifier === subscriptionIdentifier)\n      ) {\n        setSubscription(null);\n        setIsFetching(false);\n      }\n    });\n\n    void fetchSubscription({ refetch: true });\n\n    return () => {\n      cleanupGetPending();\n      cleanupGetResolved();\n      cleanupCreatePending();\n      cleanupCreateResolved();\n      cleanupUpdateResolved();\n      cleanupDeletePending();\n      cleanupDeleteResolved();\n    };\n  }, [novu, fetchSubscription]);\n\n  const refetch = useCallback(() => fetchSubscription({ refetch: true }), [fetchSubscription]);\n\n  return {\n    subscription,\n    error,\n    isLoading,\n    isFetching,\n    refetch,\n  };\n};\n"],"mappings":"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","names":["subscription","error"]}