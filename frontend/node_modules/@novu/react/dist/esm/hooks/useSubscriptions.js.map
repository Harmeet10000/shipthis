{"version":3,"sources":["../../../src/hooks/useSubscriptions.ts"],"sourcesContent":["import { NovuError, TopicSubscription } from '@novu/js';\nimport { useCallback, useEffect, useState } from 'react';\nimport { useNovu } from './NovuProvider';\n\n/**\n * Get all subscriptions for a topic.\n * Props for the useSubscriptions hook.\n *\n * @example\n * ```tsx\n * // Get all subscriptions for a topic\n * const { subscriptions } = useSubscriptions({\n *   topicKey: 'my-topic'\n * });\n *\n * // Get subscriptions with callbacks\n * const { subscriptions, refetch } = useSubscriptions({\n *   topicKey: 'my-topic',\n *   onSuccess: (data) => console.log('Loaded:', data),\n *   onError: (error) => console.error('Error:', error)\n * });\n * ```\n */\nexport type UseSubscriptionsProps = {\n  topicKey: string;\n  onSuccess?: (data: TopicSubscription[]) => void;\n  onError?: (error: NovuError) => void;\n};\n\nexport type UseSubscriptionsResult = {\n  subscriptions?: TopicSubscription[];\n  error?: NovuError;\n  isLoading: boolean;\n  isFetching: boolean;\n  refetch: () => Promise<void>;\n};\n\nexport const useSubscriptions = ({ topicKey, onSuccess, onError }: UseSubscriptionsProps): UseSubscriptionsResult => {\n  const novu = useNovu();\n  const [data, setData] = useState<TopicSubscription[]>();\n  const [error, setError] = useState<NovuError>();\n  const [isLoading, setIsLoading] = useState(true);\n  const [isFetching, setIsFetching] = useState(false);\n\n  const fetchSubscriptions = useCallback(\n    async (options?: { refetch: boolean }) => {\n      if (options?.refetch) {\n        setError(undefined);\n        setIsLoading(true);\n        novu.subscriptions.cache.invalidate({ topicKey });\n      }\n      setIsFetching(true);\n\n      const response = await novu.subscriptions.list({ topicKey }, { refetch: options?.refetch });\n\n      if (response.error) {\n        setError(response.error);\n        onError?.(response.error);\n      } else if (response.data) {\n        onSuccess?.(response.data);\n        setData(response.data);\n      }\n      setIsLoading(false);\n      setIsFetching(false);\n    },\n    [novu, topicKey, onError, onSuccess]\n  );\n\n  useEffect(() => {\n    const cleanupListPending = novu.on('subscriptions.list.pending', ({ args }) => {\n      if (args.topicKey !== topicKey) {\n        return;\n      }\n      setIsFetching(true);\n    });\n\n    const cleanupListResolved = novu.on('subscriptions.list.resolved', ({ args, data, error }) => {\n      if (args.topicKey !== topicKey) {\n        return;\n      }\n      if (error) {\n        setError(error as NovuError);\n        onError?.(error as NovuError);\n      } else if (data) {\n        onSuccess?.(data);\n        setData(data);\n      }\n      setIsLoading(false);\n      setIsFetching(false);\n    });\n\n    const cleanupListUpdated = novu.on('subscriptions.list.updated', ({ data }) => {\n      if (data.topicKey !== topicKey) {\n        return;\n      }\n      setData(data.subscriptions);\n    });\n\n    const cleanupCreateResolved = novu.on('subscription.create.resolved', ({ args, data }) => {\n      if (args.topicKey !== topicKey) {\n        return;\n      }\n      if (data) {\n        void fetchSubscriptions({ refetch: true });\n      }\n    });\n\n    const cleanupDeleteResolved = novu.on('subscription.delete.resolved', ({ args }) => {\n      const deleteTopicKey = 'subscription' in args ? args.subscription.topicKey : topicKey;\n      if (deleteTopicKey !== topicKey) {\n        return;\n      }\n      void fetchSubscriptions({ refetch: true });\n    });\n\n    void fetchSubscriptions({ refetch: true });\n\n    return () => {\n      cleanupListPending();\n      cleanupListResolved();\n      cleanupListUpdated();\n      cleanupCreateResolved();\n      cleanupDeleteResolved();\n    };\n  }, [topicKey, novu, fetchSubscriptions, onError, onSuccess]);\n\n  const refetch = useCallback(() => {\n    return fetchSubscriptions({ refetch: true });\n  }, [fetchSubscriptions]);\n\n  return {\n    subscriptions: data,\n    error,\n    isLoading,\n    isFetching,\n    refetch,\n  };\n};\n"],"mappings":"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","names":["data","error"]}